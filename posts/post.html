
<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title id="postTitle">Bài viết</title>
    <link rel="stylesheet" href="../styles.css" />
    <link rel="icon" href="../assets/favicon.png" />
    <link href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css" rel="stylesheet">
</head>

<body>
    <main class="section">
        <div class="container">
            <article class="article">
                <h1 id="articleTitle">Đang tải...</h1>
                <div class="meta" id="articleMeta"></div>
                <div id="articleContent"></div>
            </article>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const contentEl = document.getElementById('articleContent');
            const titleEl = document.getElementById('articleTitle');
            const metaEl = document.getElementById('articleMeta');

            // 1. Lấy tên file từ URL (ví dụ: ?file=bai-viet-dau-tien.md)
            const params = new URLSearchParams(window.location.search);
            const fileName = params.get('file');

            if (!fileName) {
                titleEl.textContent = 'Lỗi: Không tìm thấy bài viết.';
                return;
            }

            // 2. Tải metadata (tiêu đề, ngày tháng) từ _index.json
            fetch('_index.json')
                .then(r => r.json())
                .then(posts => {
                    const post = posts.find(p => p.file === fileName);
                    if (post) {
                        // Cập nhật tiêu đề và meta
                        titleEl.textContent = post.title;
                        document.getElementById('postTitle').textContent = post.title;
                        metaEl.textContent = post.date ? `Ngày đăng: ${post.date}` : '';

                        // *Tải nội dung Markdown*
                        return fetch(fileName);
                    } else {
                        throw new Error('Bài viết không tồn tại trong index.');
                    }
                })
                .then(r => r.text())
                .then(markdown => {
                    // 3. Chuyển Markdown sang HTML an toàn
                    const rawHtml = marked.parse(markdown);
                    const cleanHtml = DOMPurify.sanitize(rawHtml);
                    contentEl.innerHTML = cleanHtml;

                    // 4. Tô màu cú pháp (Highlighting) cho các khối code
                    document.querySelectorAll('pre code').forEach((el) => {
                        // Phải đảm bảo khối code đã được tải trước khi tô màu
                        hljs.highlightElement(el);
                    });
                })
                .catch(e => {
                    console.error("Lỗi tải bài viết:", e);
                    titleEl.textContent = 'Lỗi tải nội dung';
                    contentEl.innerHTML = `<p>Không thể tải nội dung bài viết. Vui lòng kiểm tra file: ${fileName}</p>`;
                });
        });
    </script>
</body>

</html>